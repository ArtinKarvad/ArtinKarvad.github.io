<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª | NeoBank</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #1e293b;
      --text: #f1f5f9;
      --accent: #22c55e;
      --accent-hover: #16a34a;
      --danger: #ef4444;
      --warning: #f59e0b;
      --border: #334155;
    }
    .light {
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #0f172a;
      --accent: #2563eb;
      --accent-hover: #1d4ed8;
      --danger: #dc2626;
      --warning: #d97706;
      --border: #e2e8f0;
    }
    body {
      margin: 0;
      font-family: 'Tahoma', sans-serif;
      background: var(--bg);
      color: var(--text);
      transition: all 0.4s;
      min-height: 100vh;
    }
    .container {
      max-width: 900px;
      margin: 40px auto;
      padding: 32px;
    }
    h1 { text-align: center; margin-bottom: 30px; }
    .login-box {
      max-width: 400px;
      margin: 100px auto;
      background: var(--card);
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      text-align: center;
    }
    input, button {
      width: 100%;
      padding: 14px;
      margin: 10px 0;
      border-radius: 12px;
      border: none;
      font-size: 1rem;
    }
    input {
      background: #334155;
      color: var(--text);
      border: 1px solid var(--border);
    }
    .light input { background: #f1f5f9; color: #000; }
    button {
      background: var(--accent);
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover { background: var(--accent-hover); }
    button.danger { background: var(--danger); }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      background: var(--card);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    th, td {
      padding: 14px;
      text-align: center;
      border-bottom: 1px solid var(--border);
    }
    th {
      background: rgba(255,255,255,0.1);
      font-weight: bold;
    }
    .light th { background: rgba(0,0,0,0.08); }
    tr:hover { background: rgba(255,255,255,0.05); }
    .actions button {
      padding: 6px 12px;
      margin: 0 4px;
      font-size: 0.9rem;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin: 30px 0;
    }
    .stat-card {
      background: var(--card);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      border: 1px solid var(--border);
    }
    .hidden { display: none; }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 12px;
    }

    /* Ø¨Ø®Ø´ Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©Ø¯ Ø±Ù‡Ú¯ÛŒØ±ÛŒ */
    .search-section {
      background: var(--card);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 30px;
      border: 1px solid var(--border);
    }
    .search-input {
      display: flex;
      gap: 10px;
    }
    .search-input input {
      flex: 1;
    }
    .receipt-card {
      background: var(--card);
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      border: 2px solid var(--accent);
      text-align: right;
    }
    .receipt-title {
      text-align: center;
      font-size: 1.4rem;
      margin-bottom: 20px;
      color: var(--accent);
    }
    .receipt-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px dashed var(--border);
    }
    .receipt-item:last-child { border: none; }
    .no-result {
      text-align: center;
      padding: 40px;
      opacity: 0.7;
      font-size: 1.1rem;
    }
  </style>
</head>
<body>

  <!-- ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯ Ø§Ø¯Ù…ÛŒÙ† -->
  <div id="adminLogin" class="login-box">
    <h1>ğŸ” Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª NeoBank</h1>
    <p>ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ†</p>
    <input id="adminUser" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø§Ø¯Ù…ÛŒÙ†" value="admin">
    <input id="adminPass" type="password" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±" value="admin123">
    <button onclick="adminLogin()">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù¾Ù†Ù„</button>
    <p style="margin-top:20px; font-size:0.8rem; opacity:0.7;">
      Ø±Ù…Ø² Ù¾ÛŒØ´â€ŒÙØ±Ø¶: admin / admin123
    </p>
  </div>

  <!-- Ù¾Ù†Ù„ Ø§ØµÙ„ÛŒ Ø§Ø¯Ù…ÛŒÙ† -->
  <div class="container hidden" id="adminPanel">
    <div class="top-bar">
      <h1>Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª NeoBank</h1>
      <div>
        <button onclick="toggleTheme()">ğŸŒ™ ØªÙ…</button>
        <button class="danger" onclick="adminLogout()">Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>

    <!-- Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©Ø¯ Ø±Ù‡Ú¯ÛŒØ±ÛŒ -->
    <div class="search-section">
      <h3 style="text-align:center; margin-bottom:16px;">ğŸ” Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©Ø¯ Ø±Ù‡Ú¯ÛŒØ±ÛŒ</h3>
      <div class="search-input">
        <input type="text" id="trackingInput" placeholder="Ú©Ø¯ Ø±Ù‡Ú¯ÛŒØ±ÛŒ Û¸ Ø±Ù‚Ù…ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" maxlength="8">
        <button onclick="searchTracking()">Ø¬Ø³ØªØ¬Ùˆ</button>
      </div>
    </div>

    <!-- Ù†ØªÛŒØ¬Ù‡ Ø¬Ø³ØªØ¬Ùˆ -->
    <div id="receiptResult"></div>

    <div class="stats">
      <div class="stat-card">
        <h3>ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h3>
        <h2 id="totalUsers">0</h2>
      </div>
      <div class="stat-card">
        <h3>Ø¬Ù…Ø¹ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ù„</h3>
        <h2 id="totalBalance">0</h2> ØªÙˆÙ…Ø§Ù†
      </div>
      <div class="stat-card">
        <h3>Ø¬Ù…Ø¹ Ø¨Ø¯Ù‡ÛŒ ÙˆØ§Ù…</h3>
        <h2 id="totalDebt">0</h2> ØªÙˆÙ…Ø§Ù†
      </div>
      <div class="stat-card">
        <h3>ØªØ¹Ø¯Ø§Ø¯ ÙˆØ§Ù… ÙØ¹Ø§Ù„</h3>
        <h2 id="activeLoans">0</h2>
      </div>
    </div>

    <h2 style="text-align:center;">Ù„ÛŒØ³Øª ØªÙ…Ø§Ù… Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h2>
    <table id="usersTable">
      <thead>
        <tr>
          <th>Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</th>
          <th>Ù…ÙˆØ¬ÙˆØ¯ÛŒ</th>
          <th>Ø¨Ø¯Ù‡ÛŒ ÙˆØ§Ù…</th>
          <th>Ù‚Ø³Ø· Ù…Ø§Ù‡Ø§Ù†Ù‡</th>
          <th>ØªØ¹Ø¯Ø§Ø¯ ØªØ±Ø§Ú©Ù†Ø´</th>
          <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const ADMIN_USERNAME = "admin";
    const ADMIN_PASSWORD = "admin123";

    function getUsers() {
      return JSON.parse(localStorage.getItem('neobank_users') || '{}');
    }

    function saveUsers(users) {
      localStorage.setItem('neobank_users', JSON.stringify(users));
    }

    function adminLogin() {
      const user = document.getElementById('adminUser').value.trim();
      const pass = document.getElementById('adminPass').value;

      if (user === ADMIN_USERNAME && pass === ADMIN_PASSWORD) {
        document.getElementById('adminLogin').classList.add('hidden');
        document.getElementById('adminPanel').classList.remove('hidden');
        loadAdminPanel();
      } else {
        alert('Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø¯Ù…ÛŒÙ† Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª!');
      }
    }

    function loadAdminPanel() {
      const users = getUsers();
      const tableBody = document.querySelector('#usersTable tbody');
      tableBody.innerHTML = '';

      let totalUsers = 0;
      let totalBalance = 0;
      let totalDebt = 0;
      let activeLoans = 0;

      for (const username in users) {
        if (username === 'admin') continue;

        const user = users[username];
        totalUsers++;
        totalBalance += user.balance || 0;
        const loanDebt = user.loan ? user.loan.debt : 0;
        const monthly = user.loan ? user.loan.monthly : 0;
        if (user.loan && loanDebt > 0) {
          totalDebt += loanDebt;
          activeLoans++;
        }

        const row = document.createElement('tr');
        row.innerHTML = `
          <td><strong>${username}</strong></td>
          <td>${(user.balance || 0).toLocaleString()} ØªÙˆÙ…Ø§Ù†</td>
          <td>${loanDebt.toLocaleString()} ØªÙˆÙ…Ø§Ù†</td>
          <td>${monthly.toLocaleString()} ØªÙˆÙ…Ø§Ù†</td>
          <td>${(user.transactions || []).length}</td>
          <td class="actions">
            <button onclick="editBalance('${username}')">ÙˆÛŒØ±Ø§ÛŒØ´ Ù…ÙˆØ¬ÙˆØ¯ÛŒ</button>
            <button onclick="clearLoan('${username}')">ØªØ³ÙˆÛŒÙ‡ ÙˆØ§Ù…</button>
            <button class="danger" onclick="deleteUser('${username}')">Ø­Ø°Ù Ú©Ø§Ø±Ø¨Ø±</button>
          </td>
        `;
        tableBody.appendChild(row);
      }

      document.getElementById('totalUsers').innerText = totalUsers;
      document.getElementById('totalBalance').innerText = totalBalance.toLocaleString();
      document.getElementById('totalDebt').innerText = totalDebt.toLocaleString();
      document.getElementById('activeLoans').innerText = activeLoans;
    }

    function searchTracking() {
      const code = document.getElementById('trackingInput').value.trim();
      if (code.length !== 8 || !/^\d+$/.test(code)) {
        document.getElementById('receiptResult').innerHTML = 
          '<div class="no-result">âš ï¸ Ú©Ø¯ Ø±Ù‡Ú¯ÛŒØ±ÛŒ Ø¨Ø§ÛŒØ¯ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Û¸ Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯</div>';
        return;
      }

      const users = getUsers();
      let results = [];

      for (const username in users) {
        const transactions = users[username].transactions || [];
        transactions.forEach(t => {
          if (t.details && t.details.includes(`Ú©Ø¯ Ø±Ù‡Ú¯ÛŒØ±ÛŒ: ${code}`)) {
            results.push({
              username,
              transaction: t
            });
          }
        });
      }

      const resultDiv = document.getElementById('receiptResult');
      if (results.length === 0) {
        resultDiv.innerHTML = '<div class="no-result">âŒ Ú©Ø¯ Ø±Ù‡Ú¯ÛŒØ±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</div>';
        return;
      }

      // Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ Ø¯Ùˆ ØªØ±Ø§Ú©Ù†Ø´ (ÙØ±Ø³ØªÙ†Ø¯Ù‡ Ùˆ Ú¯ÛŒØ±Ù†Ø¯Ù‡) Ø¯Ø§Ø±ÛŒÙ…
      let sender = results.find(r => r.transaction.amount < 0);
      let receiver = results.find(r => r.transaction.amount > 0);

      if (!sender || !receiver) {
        resultDiv.innerHTML = '<div class="no-result">âš ï¸ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ø§Ù‚Øµ Ø§Ø³Øª</div>';
        return;
      }

      const amount = Math.abs(sender.transaction.amount);

      resultDiv.innerHTML = `
        <div class="receipt-card">
          <div class="receipt-title">ğŸ§¾ Ø±Ø³ÛŒØ¯ ØªØ±Ø§Ú©Ù†Ø´</div>
          <div class="receipt-item">
            <span>Ú©Ø¯ Ø±Ù‡Ú¯ÛŒØ±ÛŒ:</span>
            <strong>${code}</strong>
          </div>
          <div class="receipt-item">
            <span>Ù…Ø¨Ù„Øº Ø§Ù†ØªÙ‚Ø§Ù„:</span>
            <strong>${amount.toLocaleString()} ØªÙˆÙ…Ø§Ù†</strong>
          </div>
          <div class="receipt-item">
            <span>Ø§Ø² Ø­Ø³Ø§Ø¨:</span>
            <strong>${sender.username}</strong>
          </div>
          <div class="receipt-item">
            <span>Ø¨Ù‡ Ø­Ø³Ø§Ø¨:</span>
            <strong>${receiver.username}</strong>
          </div>
          <div class="receipt-item">
            <span>ØªØ§Ø±ÛŒØ® Ùˆ Ø²Ù…Ø§Ù†:</span>
            <strong>${sender.transaction.date}</strong>
          </div>
          <div style="text-align:center; margin-top:20px; opacity:0.8;">
            ØªØ±Ø§Ú©Ù†Ø´ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡ Ø§Ø³Øª âœ…
          </div>
        </div>
      `;
    }

    // Enter key support
    document.getElementById('trackingInput').addEventListener('keypress', e => {
      if (e.key === 'Enter') searchTracking();
    });

    function editBalance(username) {
      const amount = prompt(`Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ ${username} Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ø¹Ø¯Ø¯):`);
      if (amount === null) return;
      const num = parseInt(amount);
      if (isNaN(num) || num < 0) return alert('Ù…Ø¨Ù„Øº Ù†Ø§Ù…Ø¹ØªØ¨Ø±');

      const users = getUsers();
      users[username].balance = num;
      saveUsers(users);
      alert(`Ù…ÙˆØ¬ÙˆØ¯ÛŒ ${username} Ø¨Ù‡ ${num.toLocaleString()} ØªØºÛŒÛŒØ± Ú©Ø±Ø¯`);
      loadAdminPanel();
    }

    function clearLoan(username) {
      if (!confirm(`ÙˆØ§Ù… ${username} Ø±Ø§ Ú©Ø§Ù…Ù„Ø§Ù‹ ØªØ³ÙˆÛŒÙ‡ Ú©Ù†ÛŒÙ…ØŸ`)) return;

      const users = getUsers();
      if (users[username].loan) {
        users[username].loan = null;
        saveUsers(users);
        alert(`ÙˆØ§Ù… ${username} ØªØ³ÙˆÛŒÙ‡ Ø´Ø¯`);
      } else {
        alert('Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± ÙˆØ§Ù… ÙØ¹Ø§Ù„ Ù†Ø¯Ø§Ø±Ø¯');
      }
      loadAdminPanel();
    }

    function deleteUser(username) {
      if (!confirm(`Ú©Ø§Ø±Ø¨Ø± ${username} Ùˆ ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§ØªØ´ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ Ø§ÛŒÙ† Ø¹Ù…Ù„ Ø¨Ø±Ú¯Ø´Øªâ€ŒÙ†Ø§Ù¾Ø°ÛŒØ± Ø§Ø³Øª!`)) return;

      const users = getUsers();
      delete users[username];
      saveUsers(users);
      alert(`Ú©Ø§Ø±Ø¨Ø± ${username} Ø­Ø°Ù Ø´Ø¯`);
      loadAdminPanel();
    }

    function adminLogout() {
      if (confirm('Ø§Ø² Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø§Ø±Ø¬ Ù…ÛŒâ€ŒØ´ÙˆÛŒØ¯ØŸ')) {
        document.getElementById('adminPanel').classList.add('hidden');
        document.getElementById('adminLogin').classList.remove('hidden');
        document.getElementById('trackingInput').value = '';
        document.getElementById('receiptResult').innerHTML = '';
      }
    }

    function toggleTheme() {
      document.body.classList.toggle('light');
      localStorage.setItem('neobank_admin_theme', document.body.classList.contains('light') ? 'light' : 'dark');
    }

    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªÙ…
    if (localStorage.getItem('neobank_admin_theme') === 'light' || 
        (!localStorage.getItem('neobank_admin_theme') && window.matchMedia('(prefers-color-scheme: light)').matches)) {
      document.body.classList.add('light');
    }
  </script>
</body>
</html>